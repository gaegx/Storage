<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 20px;
        }
        .row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .col {
            flex: 1;
            min-width: 300px;
        }
        ul {
            list-style: none;
            padding: 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        li {
            padding: 8px 10px;
            border-bottom: 1px solid #ddd;
        }
        li.file {
            cursor: pointer;
        }
        li.directory {
            cursor: default;
        }
        li.active {
            background-color: #007bff;
            color: white;
        }
        li:last-child {
            border-bottom: none;
        }
        .file-tree {
            padding-left: 20px;
        }
        .file-tree .directory > span::before {
            content: 'üìÅ ';
        }
        .file-tree .file::before {
            content: 'üìÑ ';
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        button {
            padding: 8px 16px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
        }
        button:nth-child(1) { background-color: #007bff; } /* –ß–∏—Ç–∞—Ç—å */
        button:nth-child(2) { background-color: #28a745; } /* –ó–∞–ø–∏—Å–∞—Ç—å */
        button:nth-child(3) { background-color: #ffc107; } /* –î–æ–±–∞–≤–∏—Ç—å */
        button:nth-child(4) { background-color: #dc3545; } /* –£–¥–∞–ª–∏—Ç—å */
        button:hover {
            opacity: 0.9;
        }
        .alert-success, .alert-danger {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
        }
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: white;
        }
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .input-group input {
            flex: 1;
        }
        .input-group button {
            background-color: #6c757d;
        }
    </style>
</head>
<body>
<div id="app">
    <div class="container">
        <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º</h1>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ –∏ –æ—à–∏–±–∫–µ -->
        <div v-if="message" class="alert-success">{{ message }}</div>
        <div v-if="error" class="alert-danger">{{ error }}</div>

        <div class="row">
            <!-- –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ -->
            <div class="col">
                <h3>–°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤</h3>
                <div v-if="!fileTree || fileTree.length === 0" class="alert-danger">
                    –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –ø—É—Å—Ç –∏–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
                </div>
                <ul v-else>
                    <file-tree :nodes="fileTree" @select-file="selectFile"></file-tree>
                </ul>
            </div>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞–º–∏ -->
            <div class="col">
                <div>
                    <label for="filename">–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª</label>
                    <input
                            type="text"
                            id="filename"
                            v-model="selectedFile"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞"
                    />
                </div>
                <div>
                    <label for="content">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞</label>
                    <textarea
                            id="content"
                            rows="5"
                            v-model="content"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞"
                    ></textarea>
                </div>
                <div>
                    <button @click="handleReadFile">–ß–∏—Ç–∞—Ç—å</button>
                    <button @click="handleWriteFile">–ó–∞–ø–∏—Å–∞—Ç—å</button>
                    <button @click="handleAppendFile">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button @click="handleDeleteFile">–£–¥–∞–ª–∏—Ç—å</button>
                </div>

                <!-- –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ -->
                <div class="card">
                    <h5>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª</h5>
                    <div class="input-group">
                        <input
                                type="text"
                                placeholder="–ù–æ–≤–æ–µ –∏–º—è —Ñ–∞–π–ª–∞"
                                v-model="copyFilename"
                        />
                        <button @click="handleCopyFile">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>

                <!-- –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ -->
                <div class="card">
                    <h5>–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ñ–∞–π–ª</h5>
                    <div class="input-group">
                        <input
                                type="text"
                                placeholder="–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è"
                                v-model="moveDir"
                        />
                        <input
                                type="text"
                                placeholder="–ù–æ–≤–æ–µ –∏–º—è —Ñ–∞–π–ª–∞"
                                v-model="moveFilename"
                        />
                        <button @click="handleMoveFile">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vue.js -->
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

<script>
    const { createApp } = Vue;

    // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ä–µ–≤–∞ —Ñ–∞–π–ª–æ–≤
    const FileTree = {
        name: 'FileTree',
        props: {
            nodes: {
                type: Array,
                required: true
            }
        },
        template: `
          <li v-for="node in nodes" :key="node.path" :class="{ 'directory': node.isDirectory, 'file': !node.isDirectory, 'active': selectedFile === node.path }">
                <span v-if="node.isDirectory" @click="toggleNode(node)">
                    {{ node.name }}
                </span>
            <span v-else @click="$emit('select-file', node.path)">
                    {{ node.name }}
                </span>
            <ul v-if="node.isDirectory && node.expanded" class="file-tree">
              <file-tree :nodes="node.children" @select-file="$emit('select-file', $event)"></file-tree>
            </ul>
          </li>
        `,
        data() {
            return {
                selectedFile: ''
            };
        },
        methods: {
            toggleNode(node) {
                node.expanded = !node.expanded;
            }
        }
    };

    createApp({
        components: {
            FileTree
        },
        data() {
            return {
                fileTree: [],
                selectedFile: '',
                content: '',
                copyFilename: '',
                moveDir: '',
                moveFilename: '',
                message: '',
                error: '',
                API_BASE_URL: 'http://localhost:8080/api/v1/storage'
            };
        },
        mounted() {
            this.fetchFiles();
        },
        methods: {
            async fetchFiles() {
                try {
                    const response = await fetch(`${this.API_BASE_URL}/list`);
                    if (!response.ok) {
                        throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log('–î–∞–Ω–Ω—ã–µ –æ—Ç API:', data); // –û—Ç–ª–∞–¥–∫–∞
                    if (!Array.isArray(data)) {
                        throw new Error('API –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: –æ–∂–∏–¥–∞–ª—Å—è –º–∞—Å—Å–∏–≤');
                    }
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø–ª–æ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ –≤ –¥–µ—Ä–µ–≤–æ
                    this.fileTree = this.buildFileTree(data);
                    this.error = '';
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –≤ fetchFiles:', err);
                    this.error = err.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤';
                    this.message = '';
                    this.fileTree = [];
                }
            },
            buildFileTree(files) {
                const tree = [];
                const map = new Map();

                // –°–æ–∑–¥–∞–µ–º —É–∑–ª—ã –¥–ª—è –≤—Å–µ—Ö –ø—É—Ç–µ–π
                files.forEach(file => {
                    const parts = file.path.split('/').filter(part => part);
                    let currentPath = '';
                    let parentMap = map;

                    parts.forEach((part, index) => {
                        currentPath = currentPath ? `${currentPath}/${part}` : part;
                        if (!parentMap.has(part)) {
                            const isLast = index === parts.length - 1;
                            const node = {
                                name: part,
                                path: currentPath,
                                isDirectory: isLast ? file.isDirectory : true,
                                children: [],
                                expanded: false
                            };
                            parentMap.set(part, node);
                            if (index === 0) {
                                tree.push(node);
                            }
                        }
                        if (index < parts.length - 1) {
                            parentMap = parentMap.get(part).childrenMap || (parentMap.get(part).childrenMap = new Map());
                            parentMap.get(part).children = parentMap.get(part).children || [];
                        } else {
                            const parentNode = parentMap.get(part);
                            if (parentNode.children.length === 0) {
                                delete parentNode.childrenMap;
                            }
                        }
                    });
                });

                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Map –≤ –º–∞—Å—Å–∏–≤ –¥–µ—Ç–µ–π
                const convertMapToArray = (nodes) => {
                    nodes.forEach(node => {
                        if (node.childrenMap) {
                            node.children = Array.from(node.childrenMap.values());
                            delete node.childrenMap;
                            convertMapToArray(node.children);
                        }
                    });
                };
                convertMapToArray(tree);

                return tree;
            },
            selectFile(path) {
                this.selectedFile = path;
                this.message = '';
                this.error = '';
            },
            async handleReadFile() {
                if (!this.selectedFile) {
                    this.error = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª';
                    this.message = '';
                    return;
                }
                try {
                    const response = await fetch(`${this.API_BASE_URL}/${this.selectedFile}`);
                    if (!response.ok) {
                        throw new Error(await response.text());
                    }
                    const data = await response.text();
                    this.content = data;
                    this.message = '–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–Ω';
                    this.error = '';
                } catch (err) {
                    this.handleError(err);
                }
            },
            async handleWriteFile() {
                if (!this.selectedFile) {
                    this.error = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª';
                    this.message = '';
                    return;
                }
                try {
                    const response = await fetch(`${this.API_BASE_URL}/${this.selectedFile}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.content)
                    });
                    if (!response.ok) {
                        throw new Error(await response.text());
                    }
                    const data = await response.text();
                    this.message = data;
                    this.error = '';
                    this.fetchFiles();
                } catch (err) {
                    this.handleError(err);
                }
            },
            async handleAppendFile() {
                if (!this.selectedFile) {
                    this.error = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª';
                    this.message = '';
                    return;
                }
                try {
                    const response = await fetch(`${this.API_BASE_URL}/${this.selectedFile}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.content)
                    });
                    if (!response.ok) {
                        throw new Error(await response.text());
                    }
                    const data = await response.text();
                    this.message = data;
                    this.error = '';
                } catch (err) {
                    this.handleError(err);
                }
            },
            async handleDeleteFile() {
                if (!this.selectedFile) {
                    this.error = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª';
                    this.message = '';
                    return;
                }
                try {
                    const response = await fetch(`${this.API_BASE_URL}/${this.selectedFile}`, {
                        method: 'DELETE'
                    });
                    if (!response.ok) {
                        throw new Error(await response.text());
                    }
                    const data = await response.text();
                    this.message = data;
                    this.error = '';
                    this.selectedFile = '';
                    this.content = '';
                    this.fetchFiles();
                } catch (err) {
                    this.handleError(err);
                }
            },
            async handleCopyFile() {
                if (!this.selectedFile || !this.copyFilename) {
                    this.error = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏ —É–∫–∞–∂–∏—Ç–µ –∏–º—è –∫–æ–ø–∏–∏';
                    this.message = '';
                    return;
                }
                try {
                    const response = await fetch(`${this.API_BASE_URL}/${this.selectedFile}/copy/${this.copyFilename}`, {
                        method: 'POST'
                    });
                    if (!response.ok) {
                        throw new Error(await response.text());
                    }
                    const data = await response.text();
                    this.message = data;
                    this.error = '';
                    this.copyFilename = '';
                    this.fetchFiles();
                } catch (err) {
                    this.handleError(err);
                }
            },
            async handleMoveFile() {
                if (!this.selectedFile || !this.moveFilename) {
                    this.error = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏ —É–∫–∞–∂–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è';
                    this.message = '';
                    return;
                }
                try {
                    const response = await fetch(`${this.API_BASE_URL}/${this.selectedFile}/move/${this.moveDir}/${this.moveFilename}`, {
                        method: 'POST'
                    });
                    if (!response.ok) {
                        throw new Error(await response.text());
                    }
                    const data = await response.text();
                    this.message = data;
                    this.error = '';
                    this.selectedFile = '';
                    this.moveDir = '';
                    this.moveFilename = '';
                    this.fetchFiles();
                } catch (err) {
                    this.handleError(err);
                }
            },
            handleError(err) {
                console.error('–û—à–∏–±–∫–∞:', err);
                this.error = err.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞';
                this.message = '';
            }
        }
    }).mount('#app');
</script>
</body>
</html>